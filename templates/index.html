<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Our Christmas Love Quest</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        .christmas-bg { background-color: #fef2f2; background-image: url('data:image/svg+xml,%3Csvg width="20" height="20" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"%3E%3Cg fill="%23d1fae5" fill-opacity="0.8" fill-rule="evenodd"%3E%3Ccircle cx="3" cy="3" r="1"/%3E%3Ccircle cx="13" cy="13" r="1"/%3E%3C/g%3E%3C/svg%3E'); }
        .app-container { max-width: 600px; min-height: 100vh; margin: 0 auto; position: relative; }
        
        /* Game Styles */
        .flip-container { perspective: 1000px; cursor: pointer; }
        .flipper { transition: 0.6s; transform-style: preserve-3d; position: relative; }
        .flip-container.flipped .flipper { transform: rotateY(180deg); }
        .front, .back { backface-visibility: hidden; position: absolute; top: 0; left: 0; width: 100%; height: 100%; border-radius: 0.75rem; display: flex; align-items: center; justify-content: center; }
        .front { z-index: 2; transform: rotateY(0deg); }
        .back { transform: rotateY(180deg); }
        
        /* Coupon Styles */
        .coupon-card { border: 4px solid #dc2626; background-color: #fff; position: relative; transition: all 0.3s ease; box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1); }
        .stamp { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%) rotate(-15deg); color: #15803d; border: 4px solid #15803d; font-size: 2rem; font-weight: 900; padding: 10px 20px; text-transform: uppercase; opacity: 0; pointer-events: none; transition: opacity 0.3s ease; z-index: 10; background: rgba(255,255,255,0.9); }
        .is-redeemed .stamp { opacity: 1; }
        .is-redeemed { filter: grayscale(0.5); opacity: 0.8; }
        .btn-festive:active { transform: scale(0.95); }
        #login-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #fef2f2; z-index: 50; display: flex; align-items: center; justify-content: center; flex-direction: column; }
        .hidden { display: none !important; }
    </style>
</head>
<body class="christmas-bg p-4 flex items-center justify-center">

    <div id="login-overlay">
        <div class="bg-white p-8 rounded-xl shadow-2xl border-t-8 border-red-600 text-center max-w-sm w-full mx-4">
            <div class="text-6xl mb-4 animate-bounce">üéÖ</div>
            <h1 class="text-2xl font-bold text-red-700 mb-6">Christmas Login</h1>
            
            <input type="text" id="username-input" placeholder="Username" 
                class="w-full p-3 border-2 border-red-200 rounded-lg mb-3 focus:outline-none focus:border-red-500">
            
            <input type="password" id="passcode-input" placeholder="Password" 
                class="w-full p-3 border-2 border-red-200 rounded-lg mb-6 focus:outline-none focus:border-red-500">
            
            <button id="login-btn" class="w-full py-3 bg-green-600 text-white font-bold rounded-lg shadow hover:bg-green-700 transition">
                Enter
            </button>
            <p id="login-error" class="text-red-500 text-xs mt-3 hidden">Invalid credentials!</p>
            <p id="loading-msg" class="text-gray-500 text-xs mt-3 hidden">Connecting to North Pole Database...</p>
        </div>
    </div>

    <div id="app-root" class="app-container w-full hidden"></div>

    <script type="module">
        // --- 1. FIREBASE IMPORTS (We use these for the Database) ---
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getDatabase, ref, set, onValue, update } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        // --- 2. YOUR SPECIFIC CONFIGURATION (I pasted your keys here) ---
        const firebaseConfig = {
            apiKey: "AIzaSyAgfC16j7ocB2vR7DDfptq1Jo_XMcSTVkE",
            authDomain: "sam-webapp-32518.firebaseapp.com",
            projectId: "sam-webapp-32518",
            storageBucket: "sam-webapp-32518.firebasestorage.app",
            messagingSenderId: "325387054592",
            appId: "1:325387054592:web:edae157d3a3630618cf2e5",
            measurementId: "G-M20ZVM21TE"
        };

        // --- 3. INITIALIZE FIREBASE & DATABASE ---
        let app, db;
        try {
            app = initializeApp(firebaseConfig);
            db = getDatabase(app); // We start the database service
            console.log("Firebase connected successfully!");
        } catch (e) {
            console.error("Firebase failed to connect:", e);
        }

        // --- 4. DATA CONSTANTS ---
        const MEMORY_PAIRS = [
            { id: 1, content: 'Rushikonda First Kiss', icon: "{{ url_for('static', filename='photo1.png') }}" },
            { id: 2, content: 'Lily Photos', icon: "{{ url_for('static', filename='photo2.png') }}" },
            { id: 3, content: 'Mickey17 Night', icon: "{{ url_for('static', filename='photo3.png') }}" },
            { id: 4, content: 'May Maggie Morning', icon: "{{ url_for('static', filename='photo4.png') }}" },
            { id: 5, content: 'Wipro Kakinada Week', icon: "{{ url_for('static', filename='photo5.png') }}" },
            { id: 6, content: 'Memory Six', icon: "{{ url_for('static', filename='photo6.png') }}" },
            { id: 7, content: 'Memory Seven', icon: "{{ url_for('static', filename='photo7.png') }}" },
            { id: 8, content: 'Memory Eight', icon: "{{ url_for('static', filename='photo8.png') }}" },
        ];
        const QUIZ_QUESTIONS = [
            { id: 1, question: "Where did we first kiss?", options: ["Area 51 cafe", "Rushikonda beach", "RK beach", "Teneti Park"], correctAnswer: "Rushikonda beach" }, 
            { id: 2, question: "What flower photos did I send you when we started texting?", options: ["Lotus", "Rose", "Lily", "Lavender"], correctAnswer: "Lily" }, 
            { id: 3, question: "What was the first movie we watched together?", options: ["Dragon", "Mickey17", "Dhadak 2", "Mad Square"], correctAnswer: "Mickey17" }, 
            { id: 4, question: "In which month we ate our first Rushikonda morning maggie?", options: ["May", "April", "June", "March"], correctAnswer: "May" }, 
            { id: 5, question: "Which company's exam was I writing when I stayed for a week in Kakinada?", options: ["Infosys", "Capgemini", "IBM", "Wipro"], correctAnswer: "Wipro" }, 
        ];
        const COUPON_QUESTIONS = [
            { 
                id: 1, 
                question: "Who is the cutest person in the world?", 
                options: ["Sampreethi", "Raghu", "Both"], 
                correct: "Sampreethi",
                rewardTitle: "The Human Taxi Service",
                rewardDesc: "One free piggyback ride whenever you feel like it. No distance limit (pls be kind)."
            },
            { 
                id: 2, 
                question: "What is raghu's favorite thing to do?", 
                options: ["Eating", "Sleeping", "Annoying Sam"], 
                correct: "Annoying Sam",
                rewardTitle: "The 'SEX' Card",
                rewardDesc: "One time validity. Your wish is my command cutu. üòâ"
            },
            { 
                id: 3, 
                question: "If Sampreethi angry, what should raghu do?", 
                options: ["Make fun of her", "Feed her food", "Ignore her"], 
                correct: "Feed her food",
                rewardTitle: "The Flower Finder",
                rewardDesc: "I will find and bring you flowers. Anytime. Anywhere."
            },
            { 
                id: 4, 
                question: "Where do Raghu belong?", 
                options: ["In Sampreethi's arms", "In hell", "In class"], 
                correct: "In Sampreethi's arms",
                rewardTitle: "The Smooth Touch",
                rewardDesc: "One uninterrupted full body massage to melt your stress away."
            },
            { 
                id: 5, 
                question: "Do you love me?", 
                options: ["Yes", "Maybe", "No"], 
                correct: "Yes",
                rewardTitle: "what you see, I see",
                rewardDesc: "We watch exactly what YOU want. Even if it's terrible, I won't complain."
            }
        ];
        const FINAL_GIFT = { title: "Merry Christmas, my cutu!", message: "I'm now coming to your wonderful college event. And you can kiss me now.\nI love youuuuu üí©", photoUrl: "{{ url_for('static', filename='final_photo.jpg') }}" };

        // --- STATE MANAGEMENT ---
        let localState = {
            quizPassed: false,
            coupons: COUPON_QUESTIONS.map(q => ({ status: 'unanswered' })),
            oweData: { raghu: { count: 0, logs: [], showLogs: false }, sampreethi: { count: 0, logs: [], showLogs: false } }
        };
        let currentUser = null;
        let currentDbPath = '';

        // --- LOGIN LOGIC ---
        document.getElementById('login-btn').addEventListener('click', handleLogin);

        function handleLogin() {
            const user = document.getElementById('username-input').value.toLowerCase().trim();
            const pass = document.getElementById('passcode-input').value.trim();
            const errorMsg = document.getElementById('login-error');
            const loadingMsg = document.getElementById('loading-msg');

            // 1. Check Credentials
            let isAdmin = (user === 'admin' && pass === 'admin');
            let isUser = (user === 'sampreethi' && pass === 'samghu3');

            if (!isAdmin && !isUser) {
                errorMsg.classList.remove('hidden');
                return;
            }

            // --- NEW LOGIC STARTS HERE ---
            // 2. Set Path based on User
            if (isAdmin) {
                currentUser = 'Admin (Test Mode)';
                currentDbPath = 'admin_test_zone'; // Separate Playground
            } else {
                currentUser = 'Sampreethi';
                currentDbPath = 'real_gift_data'; // The Real Data
            }
            // --- NEW LOGIC ENDS HERE ---

            // 3. Hide Login, Show Loading
            errorMsg.classList.add('hidden');
            loadingMsg.classList.remove('hidden');

            // 4. Connect to the SPECIFIC Path (Changed 'shared_data' to currentDbPath)
            const dataRef = ref(db, currentDbPath); 
            
            onValue(dataRef, (snapshot) => {
                // ... (rest of your existing code inside onValue remains the same)
                loadingMsg.classList.add('hidden');
                document.getElementById('login-overlay').classList.add('hidden');
                document.getElementById('app-root').classList.remove('hidden');
                
                const data = snapshot.val();
                if (data) {
                    localState = data;
                    if(!localState.oweData) localState.oweData = { raghu: { count: 0, logs: [] }, sampreethi: { count: 0, logs: [] } };
                    if(!localState.coupons) localState.coupons = COUPON_QUESTIONS.map(q => ({ status: 'unanswered' }));
                } else {
                    set(dataRef, localState);
                }
                
                if(currentView === 'start') renderStartScreen();
                else if(currentView === 'coupons') renderCoupons();
                else if(currentView === 'owe') renderOweTracker();
            });
        }

        // --- DATABASE SYNC ---
        function syncToCloud() {
            set(ref(db, currentDbPath), localState); // <--- Use the variable here
        }

        // --- APP LOGIC ---
        const appRoot = document.getElementById('app-root');
        let currentView = 'start';
        let currentQuestionIndex = 0;
        let answers = {};
        
        // Expose functions to window for HTML onclicks
        window.renderStartScreen = renderStartScreen;
        window.renderQuiz = renderQuiz;
        window.renderCoupons = renderCoupons;
        window.renderOweTracker = renderOweTracker;
        window.checkCouponAnswer = checkCouponAnswer;
        window.redeemCoupon = redeemCoupon;
        window.updateOwe = updateOwe;
        window.toggleLogs = toggleLogs;
        window.logout = () => location.reload();
        window.initializeGame = initializeGame;
        window.handleTileClick = handleTileClick;
        window.renderMatchingGame = renderMatchingGame;
        
        function renderStartScreen() {
            currentView = 'start';
            appRoot.innerHTML = `
                <div class="text-center p-8 bg-white rounded-xl shadow-2xl border-t-8 border-red-600 relative overflow-hidden">
                    <div class="absolute top-0 right-0 text-4xl opacity-20">‚ùÑÔ∏è</div>
                    <div class="absolute top-0 left-0 text-4xl opacity-20">üéÑ</div>
                    <div class="text-7xl mb-2 animate-bounce">üéÖ</div>
                    <h1 class="text-4xl font-extrabold text-red-700 mb-2">Christmas Love Quest</h1>
                    <p class="text-green-700 font-medium mb-8">Logged in as: <span class="font-bold">${currentUser}</span></p>
                    
                    <div class="space-y-4">
                        <button onclick="renderQuiz()" class="btn-festive w-full py-4 px-6 bg-red-600 text-white font-bold text-lg rounded-xl shadow-lg border-b-4 border-red-800">üéÆ Play Memory Game</button>
                        <button onclick="renderCoupons()" class="btn-festive w-full py-4 px-6 bg-green-600 text-white font-bold text-lg rounded-xl shadow-lg border-b-4 border-green-800">üéÅ Unwrap Coupons</button>
                        <button onclick="renderOweTracker()" class="btn-festive w-full py-4 px-6 bg-yellow-500 text-red-900 font-bold text-lg rounded-xl shadow-lg border-b-4 border-yellow-600">üìù "You Owe Me" List</button>
                        <button onclick="logout()" class="text-xs text-gray-400 underline mt-4">Logout</button>
                    </div>
                </div>
            `;
        }

        // --- QUIZ ---
        function renderQuiz() {
            currentView = 'quiz';
            const q = QUIZ_QUESTIONS[currentQuestionIndex];
            if (!q) { renderQuizResult(); return; }
            
            appRoot.innerHTML = `
                <div class="p-6 bg-white rounded-xl shadow-2xl border-t-4 border-green-600">
                    <p onclick="renderStartScreen()" class="back-btn text-red-600 font-bold mb-4">‚Üê Home</p>
                    <div class="text-sm text-green-600 font-bold uppercase">Question ${currentQuestionIndex + 1}/${QUIZ_QUESTIONS.length}</div>
                    <h2 class="text-2xl font-bold text-gray-800 mb-6">${q.question}</h2>
                    <div id="opts" class="space-y-3"></div>
                </div>`;
            
            q.options.forEach(opt => {
                const btn = document.createElement('button');
                btn.textContent = opt;
                btn.className = "w-full text-left py-3 px-4 bg-red-50 text-gray-800 rounded-lg hover:bg-red-100 border border-red-100 font-medium";
                btn.onclick = () => { answers[q.id] = opt; currentQuestionIndex++; renderQuiz(); };
                document.getElementById('opts').appendChild(btn);
            });
        }

        function renderQuizResult() {
            const score = QUIZ_QUESTIONS.filter(q => answers[q.id] === q.correctAnswer).length;
            const passed = score === QUIZ_QUESTIONS.length;
            if(passed) { localState.quizPassed = true; syncToCloud(); }

            appRoot.innerHTML = `
                <div class="text-center p-8 bg-white rounded-xl shadow-2xl border-t-4 ${passed?'border-green-500':'border-red-500'}">
                    <h2 class="text-3xl font-bold mb-4">Quiz Complete!</h2>
                    <p class="text-5xl font-extrabold mb-6 ${passed?'text-green-600':'text-red-600'}">${score}/${QUIZ_QUESTIONS.length}</p>
                    ${passed ? `<button onclick="initializeGame(); renderMatchingGame()" class="w-full py-3 bg-red-600 text-white font-bold rounded-xl shadow-lg">Level 2: Memories</button>` : `<button onclick="location.reload()" class="w-full py-3 bg-gray-400 text-white font-bold rounded-xl">Try Again</button>`}
                </div>`;
        }

        // --- MEMORY GAME ---
        let gameTiles = [], flippedTiles = [], matchedPairs = 0, lockBoard = false;
        function initializeGame() {
            const d = MEMORY_PAIRS.flatMap(p => [{...p, uuid: p.id+'a'}, {...p, uuid: p.id+'b'}]);
            gameTiles = d.sort(() => 0.5 - Math.random()).map(t => ({...t, isFlipped:false, isMatched:false}));
            flippedTiles = []; matchedPairs = 0;
        }
        function renderMatchingGame() {
            appRoot.innerHTML = `<div class="text-center p-4 bg-white rounded-xl shadow-2xl border-t-4 border-red-600"><div class="grid grid-cols-4 gap-2" id="board"></div></div>`;
            gameTiles.forEach((t, i) => {
                const el = document.createElement('div');
                el.className = `flip-container aspect-square ${t.isFlipped?'flipped':''} ${t.isMatched?'invisible':''}`;
                el.innerHTML = `<div class="flipper w-full h-full"><div class="front bg-red-100 rounded-lg flex items-center justify-center text-3xl">üéÅ</div><div class="back bg-white border-2 border-red-500 rounded-lg overflow-hidden"><img src="${t.icon}" class="w-full h-full object-cover"></div></div>`;
                el.onclick = () => handleTileClick(i);
                document.getElementById('board').appendChild(el);
            });
        }
        function handleTileClick(i) {
            if(lockBoard || gameTiles[i].isFlipped) return;
            gameTiles[i].isFlipped = true; flippedTiles.push(i); renderMatchingGame();
            if(flippedTiles.length === 2) {
                lockBoard = true;
                const [a,b] = flippedTiles;
                if(gameTiles[a].id === gameTiles[b].id) {
                    setTimeout(() => { gameTiles[a].isMatched=gameTiles[b].isMatched=true; matchedPairs++; flippedTiles=[]; lockBoard=false; renderMatchingGame(); if(matchedPairs===MEMORY_PAIRS.length) renderFinal(); }, 600);
                } else {
                    setTimeout(() => { gameTiles[a].isFlipped=gameTiles[b].isFlipped=false; flippedTiles=[]; lockBoard=false; renderMatchingGame(); }, 800);
                }
            }
        }
        function renderFinal() {
            appRoot.innerHTML = `<div class="text-center p-8 bg-white rounded-xl shadow-2xl border-t-4 border-yellow-400"><h1 class="text-3xl font-bold text-red-600 mb-4">${FINAL_GIFT.title}</h1><img src="${FINAL_GIFT.photoUrl}" class="w-full rounded-lg mb-4"><p>${FINAL_GIFT.message}</p><button onclick="renderStartScreen()" class="mt-4 px-6 py-2 bg-gray-100 rounded-full font-bold">Back</button></div>`;
        }

        // --- COUPONS ---
        function renderCoupons() {
            currentView = 'coupons';
            appRoot.innerHTML = `<div class="p-4 bg-white rounded-xl shadow-2xl border-t-4 border-green-600 min-h-screen"><div class="flex items-center mb-6"><button onclick="renderStartScreen()" class="text-red-600 font-bold mr-4">‚Üê Back</button><h2 class="text-2xl font-bold text-gray-800">Christmas Coupons</h2></div><div id="list" class="space-y-6"></div></div>`;
            
            COUPON_QUESTIONS.forEach((q, idx) => {
                const s = localState.coupons[idx];
                const div = document.createElement('div');
                if(s.status === 'unanswered') {
                    div.innerHTML = `<div class="bg-red-50 p-5 rounded-lg border border-red-100"><h3 class="font-bold text-red-800 mb-3">üéÅ Gift #${idx+1}</h3><p class="mb-3 text-sm">${q.question}</p><div class="space-y-2 mb-3">${q.options.map(o => `<label class="flex items-center space-x-2 p-2 bg-white rounded"><input type="radio" name="q${idx}" value="${o}"><span>${o}</span></label>`).join('')}</div><button onclick="checkCouponAnswer(${idx})" class="w-full py-2 bg-green-600 text-white rounded font-bold">Unlock</button></div>`;
                } else {
                    const r = s.status === 'redeemed';
                    div.innerHTML = `<div class="coupon-card p-6 rounded-lg text-center ${r?'is-redeemed':''}"><div class="stamp">Redeemed üéÖ</div><div class="text-4xl mb-2">ü¶å</div><h3 class="text-xl font-black text-red-600">${q.rewardTitle}</h3><p class="text-sm text-gray-600 mb-4">${q.rewardDesc}</p><button onclick="redeemCoupon(${idx})" ${r?'disabled' : ''} class="px-6 py-2 ${r?'bg-gray-300':'bg-red-600 hover:bg-red-700'} text-white font-bold rounded-full">${r?'Used':'Redeem Now'}</button></div>`;
                }
                document.getElementById('list').appendChild(div);
            });
        }

        function checkCouponAnswer(idx) {
            const sel = document.querySelector(`input[name="q${idx}"]:checked`);
            if(!sel) return alert("Pick an answer!");
            if(sel.value === COUPON_QUESTIONS[idx].correct) {
                localState.coupons[idx].status = 'won';
                syncToCloud();
            } else alert("Try again!");
        }

        function redeemCoupon(idx) {
            if(confirm("Redeem this gift?")) {
                localState.coupons[idx].status = 'redeemed';
                syncToCloud();
            }
        }

        // --- OWE TRACKER ---
        function renderOweTracker() {
            currentView = 'owe';
            appRoot.innerHTML = `<div class="p-6 bg-white rounded-xl shadow-2xl border-t-4 border-yellow-500 min-h-screen"><div class="flex items-center mb-6"><button onclick="renderStartScreen()" class="text-yellow-600 font-bold mr-4">‚Üê Back</button><h2 class="text-2xl font-bold text-gray-800">Naughty & Nice List</h2></div><div class="grid grid-cols-1 md:grid-cols-2 gap-6">${renderPC('raghu', 'Raghu')}${renderPC('sampreethi', 'Sampreethi')}</div></div>`;
        }

        function renderPC(key, name) {
            const d = localState.oweData[key];
            if(!d.logs) d.logs = [];
            const logs = d.logs.slice(0, 10).map(l => `<li class="text-xs text-gray-500 flex justify-between border-b py-1"><span>${l.msg}</span><span>${l.date}</span></li>`).join('');
            return `<div class="bg-red-50 rounded-xl p-4 border border-red-100 relative"><div class="absolute -top-3 -right-3 text-2xl">üéÖ</div><h3 class="text-xl font-bold text-red-800 text-center mb-2">${name}</h3><div class="text-center mb-4"><span class="text-5xl font-black ${d.count>=0?'text-green-600':'text-red-500'}">${d.count}</span><p class="text-xs text-gray-400 uppercase tracking-widest mt-1">Total Owes</p></div><div class="flex justify-center gap-4 mb-4"><button onclick="updateOwe('${key}', -1)" class="w-12 h-12 rounded-full bg-white border border-red-200 text-red-600 font-bold text-xl shadow">-</button><button onclick="updateOwe('${key}', 1)" class="w-12 h-12 rounded-full bg-white border border-green-200 text-green-600 font-bold text-xl shadow">+</button></div><div class="text-center"><button onclick="toggleLogs('${key}')" class="text-xs text-yellow-600 font-bold underline mb-2">${d.showLogs?'Hide History':'Show History'}</button>${d.showLogs?`<ul class="text-left bg-white p-2 rounded shadow-inner max-h-40 overflow-y-auto">${logs}</ul>`:''}</div></div>`;
        }

        function updateOwe(person, change) {
            localState.oweData[person].count += change;
            localState.oweData[person].logs.unshift({ date: new Date().toLocaleString('en-IN', {month:'short', day:'numeric', hour:'2-digit', minute:'2-digit'}), msg: change>0?'Added 1 owe':'Removed 1 owe' });
            syncToCloud();
        }

        function toggleLogs(person) {
            localState.oweData[person].showLogs = !localState.oweData[person].showLogs;
            renderOweTracker();
        }
    </script>
</body>
</html>



